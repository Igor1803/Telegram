# Описание логики принятия решений

## Общая архитектура принятия решений

AI-модуль использует LLM (GPT-4o) для принятия решений на основе естественного диалога с клиентом. Вся логика принятия решений заложена в системном промпте, который направляет поведение AI.

## Процесс квалификации

### 1. Начало диалога

**Триггер**: Пользователь отправляет `/start`

**Действие**: 
- Создаётся новый диалог в storage
- AI генерирует открытое приветственное сообщение
- Сообщение сохраняется в истории диалога

**Критерии успеха**: 
- Сообщение естественное, не шаблонное
- Нет упоминаний ИИ или технологий
- Тон дружелюбный и человеческий

### 2. Ведение диалога

**Триггер**: Каждое сообщение от пользователя

**Действие**:
1. Сообщение пользователя добавляется в историю
2. Вся история диалога отправляется в LLM с системным промптом
3. LLM анализирует контекст и генерирует ответ
4. Ответ сохраняется в истории

**Логика принятия решений AI**:

AI анализирует диалог и решает:
- **Что спросить дальше**: на основе того, какая информация уже получена и какая отсутствует
- **Как сформулировать вопрос**: естественно, без шаблонов, уместно в контексте
- **Когда вернуть к теме**: если клиент отклоняется, мягко возвращает разговор к квалификации
- **Когда завершить диалог**: когда получено достаточно информации или клиент готов завершить

**Критерии для продолжения диалога**:
- Не все ключевые параметры выяснены (запрос, сроки, масштаб, КЭВ)
- Клиент активно отвечает и готов общаться
- Есть неясности, требующие уточнения

**Критерии для завершения диалога**:
- Получена достаточная информация для формирования саммари
- Клиент явно хочет завершить разговор
- Клиент не отвечает на вопросы или уходит от темы после нескольких попыток

### 3. Извлечение информации

AI извлекает информацию из диалога в процессе общения:

#### Запрос клиента
- **Что ищет**: Любые упоминания о потребности, проблеме, задаче клиента
- **Как извлекается**: AI анализирует контекст всего диалога и формулирует запрос в свободной форме
- **Примеры**: "Автоматизация складского учёта", "CRM система для малой компании", "Разработка мобильного приложения"

#### Сроки
- **Что ищет**: Упоминания конкретных дат, периодов, временных рамок
- **Категории**:
  - "есть до 12 мес" - конкретные сроки в пределах года
  - "24+ мес" - долгосрочные планы (более 2 лет)
  - "нет" - нет конкретных сроков
  - "не определены" - клиент не знает или не определился
- **Как извлекается**: AI ищет временные маркеры в ответах клиента
- **Примеры**: "до конца года", "в следующем квартале", "через пару лет", "пока не знаю"

#### Масштаб
- **Что ищет**: Информацию о размере компании, объёме проекта, количестве пользователей
- **Категории**:
  - "малый" - небольшая компания/проект (до 20-30 человек)
  - "средний" - средняя компания/проект (30-200 человек)
  - "крупный" - крупная компания/проект (200+ человек)
  - "неизвестен" - недостаточно информации для определения
- **Как извлекается**: AI анализирует упоминания количества сотрудников, объёмов, масштабов
- **Примеры**: "10 человек", "около 50 сотрудников", "5000 позиций", "небольшая компания"

#### КЭВ (Критерий экономической выгоды)
- **Что ищет**: Упоминания бюджета, готовности инвестировать, наличия средств
- **Категории**:
  - "да" - есть бюджет, готовность инвестировать подтверждена
  - "нет" - нет бюджета или готовности
  - "не определено" - клиент не определился или не ответил
- **Как извлекается**: AI ищет упоминания бюджета, денег, инвестиций, готовности платить
- **Примеры**: "есть бюджет", "выделили 2 миллиона", "пока нет денег", "нужно найти инвесторов"

### 4. Категоризация лида

**Триггер**: Завершение диалога

**Логика категоризации**:

```
ЕСЛИ (сроки = "есть до 12 мес" И КЭВ = "да"):
    категория = A
ИНАЧЕ ЕСЛИ (КЭВ = "нет"):
    категория = A ЗАПРЕЩЕНА (должна быть B или C)
ИНАЧЕ ЕСЛИ (интерес есть И (нет сроков ИЛИ нет КЭВ)):
    категория = B
ИНАЧЕ ЕСЛИ (нет готовности ИЛИ сроки = "24+ мес"):
    категория = C
```

**Правила**:
1. **Категория A**: Только если есть сроки до 12 мес И КЭВ = да. Запрещена, если КЭВ = нет.
2. **Категория B**: Интерес есть, но не хватает либо сроков, либо КЭВ, либо обоих.
3. **Категория C**: Нет готовности к проекту или очень долгие сроки (24+ мес).

**Важно**: AI не может присвоить категорию A, если КЭВ = нет, даже если есть сроки.

### 5. Формирование саммари

**Триггер**: AI определяет, что диалог завершён

**Процесс**:
1. AI анализирует всю историю диалога
2. Извлекает информацию по каждому параметру (запрос, сроки, масштаб, КЭВ)
3. Определяет категорию на основе правил категоризации
4. Формулирует следующий шаг (рекомендацию для менеджера)
5. Формирует структурированное саммари

**Формат саммари**:
```
Запрос клиента: [свободная формулировка на основе диалога]
Сроки: [есть до 12 мес / 24+ мес / нет / не определены]
Масштаб: [малый / средний / крупный / неизвестен]
КЭВ: [да / нет / не определено]
Следующий шаг: [краткая рекомендация]
Категория: [A / B / C]
```

**Принципы формирования**:
- **Короткость**: Саммари должно быть кратким, без лишних деталей
- **Точность**: Только факты из диалога, без домыслов
- **Полезность**: Пригодно для передачи менеджеру или в CRM

## Ограничения и правила

### Что AI запрещено делать

1. **Консультировать**: Не объясняет продукт, не даёт советы по выбору
2. **Обещать**: Не обещает результаты, не гарантирует успех
3. **Уговаривать**: Не давит на клиента, не пытается продать
4. **Использовать скрипты**: Не ведёт диалог по жёсткому шаблону
5. **Придумывать данные**: Если информация не получена, указывает "не определено"

### Что AI обязан делать

1. **Вежливо обозначать границы**: Если клиент просит консультацию, вежливо объясняет, что это не его задача
2. **Сохранять нейтральный тон**: Не эмоциональный, не навязчивый
3. **Быть естественным**: Диалог должен выглядеть как общение с человеком
4. **Возвращать к теме**: Мягко возвращает разговор к квалификации при отклонениях

## Примеры принятия решений

### Пример 1: Определение категории A

**Диалог**:
- Клиент: "Нужна автоматизация, хотим до конца года, бюджет есть"

**Решение AI**:
- Запрос: "Автоматизация"
- Сроки: "есть до 12 мес" (до конца года)
- КЭВ: "да" (бюджет есть)
- Категория: A ✓

### Пример 2: Запрет категории A

**Диалог**:
- Клиент: "Нужна система, хотим до лета, но денег пока нет"

**Решение AI**:
- Сроки: "есть до 12 мес" (до лета)
- КЭВ: "нет" (денег нет)
- Категория: B (не A, т.к. КЭВ = нет) ✓

### Пример 3: Определение категории C

**Диалог**:
- Клиент: "Интересует разработка, но это через пару лет, пока только идея"

**Решение AI**:
- Сроки: "24+ мес" (через пару лет)
- Готовность: низкая (только идея)
- Категория: C ✓

## Техническая реализация

### Системный промпт

Вся логика принятия решений заложена в системном промпте (`prompts.py`). Промпт:
- Описывает роль AI (помощник менеджера)
- Устанавливает принципы общения
- Определяет, что нужно выяснить
- Задаёт правила категоризации
- Форматирует выходные данные

### Обработка ответа LLM

1. **Генерация ответа**: LLM генерирует ответ на основе промпта и истории
2. **Парсинг маркеров**: Проверяется наличие маркера `[DIALOG_COMPLETE]`
3. **Извлечение саммари**: Если диалог завершён, извлекается саммари из секции `[SUMMARY]...[/SUMMARY]`
4. **Очистка ответа**: Удаляются служебные маркеры перед отправкой клиенту

### Валидация категории

После извлечения саммари можно добавить валидацию:
```python
def validate_category(summary: dict) -> bool:
    category = summary.get("Категория", "")
    kpv = summary.get("КЭВ", "")
    
    if category == "A" and kpv != "да":
        return False  # Нарушение правила
    return True
```

## Мониторинг качества решений

### Метрики для оценки

1. **Естественность диалога**: Диалог не должен выглядеть как анкетирование
2. **Полнота информации**: Сколько параметров удалось выяснить
3. **Корректность категории**: Соответствие категории правилам
4. **Качество саммари**: Полезность для менеджера

### Возможные проблемы

1. **AI консультирует**: Нужно усилить промпт о запрете консультаций
2. **Шаблонные ответы**: Нужно добавить разнообразие в промпт
3. **Неправильная категория**: Нужно уточнить правила в промпте
4. **Неполное саммари**: Нужно усилить требования к формату

## Улучшение логики

### Возможные улучшения

1. **Контекстная память**: Сохранение информации о предыдущих диалогах с клиентом
2. **Адаптивные вопросы**: Вопросы меняются в зависимости от ответов
3. **Многоуровневая категоризация**: Более детальная категоризация (A1, A2, B1, B2 и т.д.)
4. **Обратная связь**: Обучение на основе оценок менеджеров
5. **Интеграция с CRM**: Автоматическая передача саммари и обогащение контекстом из CRM

